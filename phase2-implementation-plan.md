# Phase 2: 主要機能実装 - 詳細実装計画書

## プロジェクト概要

### 実装目標
保育士業務支援アプリの3つの主要機能を実装し、AI生成による業務効率化を実現する

**主要機能:**
1. **メール文作成機能** - 保護者向け日常報告メール（最優先）
2. **保育日誌作成機能** - 園内記録用日誌（最優先）
3. **児童票作成機能** - 園児個別成長記録（高優先度）

### 技術アーキテクチャ

#### フロントエンド技術スタック
- **Next.js 15.3.4** - App Router、SSR/CSR対応
- **React 19** - 最新のReact機能活用
- **TypeScript 5** - 厳密な型安全性
- **Tailwind CSS v4** - モバイルファーストデザイン

#### バックエンド・AI統合
- **OpenAI API** - GPT-4o-miniモデル使用
- **Supabase** - データベース、認証、リアルタイム機能
- **Edge Functions** - サーバーレス関数実行

#### データフロー設計
```
入力 → プロンプト生成 → OpenAI API → 3パターン生成 → UI表示 → コピー機能
  ↓
履歴保存 → データベース → 検索・フィルタ → 再利用・分析
```

## 並列実装戦略

### 実装アプローチ
- **6波構成**: 依存関係を考慮した段階的実装
- **並列処理**: 可能な部分は複数Agentで同時実装
- **統合ポイント**: 各波完了時に統合テスト実施

### Wave依存関係マップ
```
Wave 1 (基盤拡張) → Wave 2 (メール文) → Wave 3 (日誌) → Wave 4 (児童票基盤) → Wave 5 (児童票完成) → Wave 6 (最終統合)
    ↓                   ↓                ↓                    ↓                      ↓                     ↓
OpenAI基盤          メール機能        日誌機能           フォーム+データ         児童票統合           全機能統合
UI基盤              完全実装          完全実装           管理システム           完成                最適化
DB拡張
```

## 詳細技術仕様

### セクション6: OpenAI API統合基盤

#### 技術要件
- **モデル**: GPT-4o-mini（コスト効率とパフォーマンスのバランス）
- **トークン制限**: 入力8,192、出力4,096トークン
- **レート制限**: ユーザー単位の制限実装
- **エラーハンドリング**: リトライ機能、詳細エラーメッセージ

#### 実装ファイル構成
```
src/lib/
├── openai.ts           # OpenAIクライアント設定
├── prompts.ts          # プロンプトテンプレート管理
├── generation.ts       # AI生成コア関数
└── rate-limit.ts       # レート制限管理
```

#### プロンプト設計戦略
**メール文プロンプト特性:**
- 保護者向けの親しみやすい文体
- 具体的すぎない表現（個人情報保護）
- クラス全体の様子を表現
- 安心感を与える内容構成

**日誌プロンプト特性:**
- 園内記録用の客観的文体
- 「〜した」調の記録スタイル
- 構造化された出力（見出し付き）
- より詳細な活動記録

**児童票プロンプト特性:**
- 6領域別の観察記録
- 個別の成長に焦点
- 目標設定のサポート

### セクション7: 共通生成UIコンポーネント

#### UI/UX設計原則
- **モバイルファースト**: 320px〜1920px対応
- **シンプル操作**: 最小限のステップで目標達成
- **視覚的フィードバック**: 生成進捗の明確な表示
- **アクセシビリティ**: WCAG 2.1 AA準拠

#### コンポーネント構成
```
src/components/generation/
├── InputForm.tsx           # 入力フォーム（キーワード+自由記入）
├── ResultDisplay.tsx       # 3パターン表示
├── CopyButton.tsx          # ワンタップコピー
├── LoadingState.tsx        # AI生成中の表示
├── GenerationLayout.tsx    # 共通レイアウト
└── HistoryPanel.tsx        # 履歴表示・管理
```

#### インタラクション設計
1. **入力段階**: キーワード選択 or 自由記入
2. **生成段階**: プログレスバー、予想時間表示
3. **結果段階**: 3パターン並列表示、比較しやすいレイアウト
4. **選択段階**: ワンタップコピー、履歴保存

### セクション8: データベース拡張・履歴管理

#### データベーススキーマ拡張
```sql
-- 拡張されたgeneration_history テーブル
ALTER TABLE generation_history ADD COLUMN IF NOT EXISTS
    generation_context JSONB,           -- 生成時のコンテキスト情報
    performance_metrics JSONB,          -- 応答時間、トークン使用量等
    user_feedback INTEGER,              -- ユーザー評価（1-5）
    tags TEXT[],                        -- タグ付け機能
    is_template BOOLEAN DEFAULT FALSE,  -- テンプレート化フラグ
    parent_id TEXT;                     -- 関連する履歴のID

-- 履歴検索用インデックス
CREATE INDEX IF NOT EXISTS idx_generation_history_search 
ON generation_history USING gin(to_tsvector('japanese', input || ' ' || output));

-- パフォーマンス用インデックス
CREATE INDEX IF NOT EXISTS idx_generation_history_user_type_date 
ON generation_history(user_id, type, created_at DESC);
```

#### 履歴管理機能
- **検索機能**: 全文検索、日付範囲、タイプ別フィルタ
- **ページネーション**: 大量データの効率的な表示
- **データ保持**: 2年間の自動保持、それ以降は自動削除
- **エクスポート**: CSV/JSON形式でのデータ出力

### セクション9-10: メール文・日誌作成機能

#### 機能別プロンプト戦略

**メール文生成プロンプト例:**
```
あなたは経験豊富な保育士です。保護者向けの温かく親しみやすいメール文を作成してください。

【重要な制約】
- 特定の園児の名前は絶対に含めない
- クラス全体の様子として表現する
- 保護者が安心できる内容にする
- 200-300文字程度の適切な長さ

【クラス情報】
- クラス: {class_name}
- 年齢: {age_range}

【今日の様子・キーワード】
{user_input}

3つの異なる文体・アプローチで作成してください：
1. 活動重視バージョン
2. 成長重視バージョン  
3. 季節・環境重視バージョン
```

**日誌生成プロンプト例:**
```
保育日誌の記録文を作成してください。園内での客観的な記録として使用します。

【記録スタイル】
- 「〜した」「〜であった」調の記録文体
- 具体的な活動内容を含む
- 時系列での構成
- 見出し付きの構造化

【構成要素】
## 午前の活動
## 午後の活動  
## 全体的な様子
## 特記事項

【入力情報】
クラス: {class_name}
日付: {date}
キーワード・様子: {user_input}
```

#### 生成品質向上機能
- **バリデーション**: 園児名検出・除外機能
- **品質チェック**: 文字数、適切性チェック
- **学習機能**: ユーザー評価による改善

### セクション11-12: 児童票作成機能

#### 6領域データ構造
```typescript
interface SixAreasData {
  yougo: AreaRecord;      // 養護
  kenkou: AreaRecord;     // 健康  
  ningenkankei: AreaRecord; // 人間関係
  kankyou: AreaRecord;    // 環境
  kotoba: AreaRecord;     // 言葉
  hyougen: AreaRecord;    // 表現
}

interface AreaRecord {
  observations: string;           // 観察記録
  development_notes: string;      // 発達状況
  goals: string;                 // 次期目標
  rating: number;                // 5段階評価
  ai_suggestions?: string;       // AI提案内容
  previous_comparison?: string;   // 前回との比較
}
```

#### 児童票ワークフロー
1. **園児選択**: 担当クラスの園児一覧から選択
2. **期間設定**: 4-6ヶ月の記録期間設定
3. **6領域入力**: 各領域の観察記録入力
4. **AI活用**: 観察記録からの発達分析・目標提案
5. **保存・比較**: 履歴保存、前回記録との比較表示

#### アクセス制御強化
- **クラス制限**: 担当クラス以外の園児データアクセス禁止
- **操作ログ**: 全ての児童票アクセス・変更をログ記録
- **データ暗号化**: 機密性の高い個人情報の暗号化保存

### セクション13: 最終統合・最適化

#### パフォーマンス最適化戦略
**目標: 3秒以内応答**

1. **フロントエンド最適化**
   - コンポーネントの遅延読み込み
   - 画像・アセットの最適化
   - キャッシュ戦略の実装

2. **API最適化**
   - OpenAI APIレスポンス時間短縮
   - データベースクエリ最適化
   - CDN活用

3. **ユーザー体験向上**
   - 段階的ローディング表示
   - オフライン機能の部分対応
   - エラー時の適切なフォールバック

#### セキュリティ強化項目
- **データ保護**: 個人情報の暗号化保存・転送
- **アクセス制御**: 厳密な権限管理
- **監査ログ**: セキュリティイベントの記録
- **入力検証**: XSS、SQLインジェクション対策

## 品質保証計画

### テスト戦略
1. **ユニットテスト**: 各関数・コンポーネントの動作確認
2. **統合テスト**: API連携、データフロー確認
3. **E2Eテスト**: ユーザーワークフロー全体の動作確認
4. **パフォーマンステスト**: 応答時間、負荷テスト
5. **セキュリティテスト**: 脆弱性スキャン、ペネトレーションテスト

### 完了基準チェックリスト
- [ ] 53タスク全て完了
- [ ] 3つの主要機能が仕様通り動作
- [ ] AI生成応答時間3秒以内達成
- [ ] モバイル対応完了（320px-1920px）
- [ ] セキュリティ要件満足
- [ ] クロスブラウザ対応確認
- [ ] 総合テスト合格

## リスク管理

### 想定リスク・対策
1. **OpenAI API制限**: レート制限対策、フォールバック機能
2. **パフォーマンス**: 段階的最適化、キャッシュ戦略
3. **セキュリティ**: 定期的監査、即座対応体制
4. **互換性**: 継続的なクロスブラウザテスト

### 品質基準
- TypeScriptコンパイルエラー: 0件
- ESLintエラー: 0件
- セキュリティ脆弱性: Critical/High 0件
- パフォーマンス: 全機能3秒以内応答

---

**最終更新**: 2025-06-20
**次のアクション**: 第1波（3並列）実装開始